<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo: PostgreSQL + Memcached</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            padding: 12px 24px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .results {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            min-height: 200px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .badge-cache {
            background: #38ef7d;
            color: white;
        }

        .badge-database {
            background: #f45c43;
            color: white;
        }

        .badge-db {
            background: #10b981;
            color: white;
        }

        .time-badge {
            background: #667eea;
            color: white;
            font-size: 1.1em;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .product-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 1.3em;
            color: #667eea;
            font-weight: 700;
            margin: 10px 0;
        }

        .product-details {
            font-size: 0.9em;
            color: #666;
            line-height: 1.6;
        }

        .stats {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: #f45c43;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .cache-keys-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .cache-keys-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .cache-keys-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        .cache-keys-table tr:hover {
            background: #f8f9fa;
        }

        .cache-key {
            font-family: 'Courier New', monospace;
            color: #667eea;
            font-weight: 600;
            max-width: 220px;
            display: block;
        }

        .cache-value {
            font-family: 'Courier New', monospace;
            color: #666;
            font-size: 0.85em;
            max-width: 600px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        .server-section {
            margin-bottom: 30px;
        }

        .server-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-count {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .btn-delete {
            background: #f45c43;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .btn-delete:hover {
            background: #eb3349;
            transform: scale(1.05);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Demo: PostgreSQL + Memcached</h1>
            <p class="subtitle">Veja a diferen√ßa de velocidade entre Cache e Banco de Dados</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="mudarAba('produtos')">
                üì¶ Produtos
            </button>
            <button class="tab" onclick="mudarAba('contadores')">
                üî¢ Contadores
            </button>
        </div>

        <!-- Aba de Produtos -->
        <div id="tab-produtos" class="tab-content active">
            <div class="controls">
                <h2 style="margin-bottom: 20px; color: #333;">Consultas R√°pidas</h2>
            
            <div class="button-group">
                <button class="btn-primary" onclick="buscarTodosProdutos()">
                    üì¶ Buscar Todos os Produtos
                </button>
                <button class="btn-success" onclick="buscarPorCategoria()">
                    üè∑Ô∏è Buscar por Categoria
                </button>
                <button class="btn-info" onclick="buscarPorPreco()">
                    üí∞ Buscar por Pre√ßo
                </button>
                <button class="btn-primary" onclick="buscarPorId()">
                    üîç Buscar por ID
                </button>
            </div>

            <div class="control-group">
                <label>Buscar Produto por ID:</label>
                <input type="number" id="produtoId" placeholder="Digite o ID do produto (1-15)" min="1">
            </div>

            <div class="control-group">
                <label>Filtrar por Categoria:</label>
                <select id="categoriaSelect">
                    <option value="">Carregando...</option>
                </select>
            </div>

            <div class="control-group">
                <label>Pre√ßo M√°ximo (R$):</label>
                <input type="number" id="precoMax" placeholder="Ex: 500" min="0" step="0.01">
            </div>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                    <h3 style="margin-bottom: 15px; color: #333;">üìä Gerenciamento de Cache</h3>
                    <div class="button-group">
                        <button class="btn-danger" onclick="limparCache()">
                            üóëÔ∏è Limpar Cache
                        </button>
                        <button class="btn-info" onclick="mostrarEstatisticas()">
                            üìä Estat√≠sticas do Cache
                        </button>
                        <button class="btn-info" onclick="inspecionarCache()">
                            üîç Inspecionar Itens do Cache
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba de Contadores -->
        <div id="tab-contadores" class="tab-content">
            <div class="controls">
                <h2 style="margin-bottom: 20px; color: #333;">üî¢ Contadores - Compara√ß√£o Memcached vs PostgreSQL</h2>
                
                <div class="control-group">
                    <label>Nome do Contador:</label>
                    <input type="text" id="contadorNome" placeholder="Ex: visitantes, likes, views" value="visitantes">
                </div>

                <h3 style="margin: 20px 0 15px 0; color: #667eea;">‚ö° Opera√ß√µes no Memcached (Cache)</h3>
                <div class="button-group">
                    <button class="btn-success" onclick="incrementarContador()">
                        ‚ûï Incrementar (+1)
                    </button>
                    <button class="btn-danger" onclick="decrementarContador()">
                        ‚ûñ Decrementar (-1)
                    </button>
                    <button class="btn-info" onclick="buscarContador()">
                        üîç Ver Valor
                    </button>
                    <button class="btn-primary" onclick="resetarContador()">
                        üîÑ Resetar
                    </button>
                </div>

                <h3 style="margin: 20px 0 15px 0; color: #10b981;">üíæ Opera√ß√µes no PostgreSQL (Banco)</h3>
                <div class="button-group">
                    <button class="btn-success" onclick="incrementarContadorDB()">
                        ‚ûï Incrementar (+1) DB
                    </button>
                    <button class="btn-danger" onclick="decrementarContadorDB()">
                        ‚ûñ Decrementar (-1) DB
                    </button>
                    <button class="btn-info" onclick="buscarContadorDB()">
                        üîç Ver Valor DB
                    </button>
                    <button class="btn-primary" onclick="resetarContadorDB()">
                        üîÑ Resetar DB
                    </button>
                </div>

                <h3 style="margin: 20px 0 15px 0; color: #f59e0b;">üèÅ Testes de Performance</h3>
                <div class="control-group">
                    <label>Quantidade de opera√ß√µes:</label>
                    <input type="number" id="contadorQuantidade" placeholder="Quantidade" value="100" min="1">
                </div>

                <div class="button-group">
                    <button class="btn-success" onclick="testePerformanceIncremento()">
                        üöÄ Teste: Incrementos em Lote
                    </button>
                    <button class="btn-danger" onclick="testePerformanceDecremento()">
                        üöÄ Teste: Decrementos em Lote
                    </button>
                    <button class="btn-info" onclick="compararAmbos()">
                        üìä Comparar Ambos
                    </button>
                </div>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                    <h3 style="margin-bottom: 15px; color: #333;">üìä Gerenciamento de Cache</h3>
                    <div class="button-group">
                        <button class="btn-danger" onclick="limparCache()">
                            üóëÔ∏è Limpar Cache
                        </button>
                        <button class="btn-info" onclick="mostrarEstatisticas()">
                            üìä Estat√≠sticas do Cache
                        </button>
                        <button class="btn-info" onclick="inspecionarCache()">
                            üîç Inspecionar Itens do Cache
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <div class="empty">
                üëÜ Selecione uma op√ß√£o acima para come√ßar
            </div>
        </div>
    </div>

    <script>
        // Carregar categorias ao iniciar
        window.onload = function() {
            carregarCategorias();
        };

        function mudarAba(aba) {
            // Remover active de todas as abas e conte√∫dos
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Adicionar active na aba clicada
            event.target.classList.add('active');
            
            // Mostrar conte√∫do correspondente
            if (aba === 'produtos') {
                document.getElementById('tab-produtos').classList.add('active');
            } else if (aba === 'contadores') {
                document.getElementById('tab-contadores').classList.add('active');
            }
            
            // Limpar resultados ao trocar de aba
            document.getElementById('results').innerHTML = '<div class="empty">üëÜ Selecione uma op√ß√£o acima para come√ßar</div>';
        }

        async function carregarCategorias() {
            try {
                const response = await fetch('/api/categorias');
                const data = await response.json();
                
                const select = document.getElementById('categoriaSelect');
                select.innerHTML = '<option value="">Selecione uma categoria</option>';
                
                data.dados.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = categoria;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        function mostrarLoading() {
            document.getElementById('results').innerHTML = '<div class="loading">Carregando</div>';
        }

        function mostrarErro(mensagem) {
            document.getElementById('results').innerHTML = 
                `<div class="error">‚ùå Erro: ${mensagem}</div>`;
        }

        async function buscarTodosProdutos() {
            mostrarLoading();
            try {
                const response = await fetch('/api/produtos');
                const data = await response.json();
                mostrarResultados(data);
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        async function buscarPorId() {
            const id = document.getElementById('produtoId').value;
            if (!id) {
                alert('Por favor, digite um ID');
                return;
            }
            
            mostrarLoading();
            try {
                const response = await fetch(`/api/produtos/${id}`);
                const data = await response.json();
                
                if (!data.sucesso) {
                    mostrarErro(data.erro);
                    return;
                }
                
                mostrarResultados(data);
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        async function buscarPorCategoria() {
            const categoria = document.getElementById('categoriaSelect').value;
            if (!categoria) {
                alert('Por favor, selecione uma categoria');
                return;
            }
            
            mostrarLoading();
            try {
                const response = await fetch(`/api/produtos/categoria/${encodeURIComponent(categoria)}`);
                const data = await response.json();
                mostrarResultados(data);
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        async function buscarPorPreco() {
            const preco = document.getElementById('precoMax').value;
            if (!preco) {
                alert('Por favor, digite um pre√ßo m√°ximo');
                return;
            }
            
            mostrarLoading();
            try {
                const response = await fetch(`/api/produtos/preco/${preco}`);
                const data = await response.json();
                mostrarResultados(data);
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        function mostrarResultados(data) {
            const produtos = Array.isArray(data.dados) ? data.dados : [data.dados];
            const origemBadge = data.origem === 'cache' 
                ? '<span class="badge badge-cache">‚ö° CACHE</span>'
                : '<span class="badge badge-database">üíæ BANCO DE DADOS</span>';
            
            let html = `
                <div class="result-header">
                    <h2>Resultados</h2>
                    <div>
                        ${origemBadge}
                        <span class="badge time-badge">‚è±Ô∏è ${data.tempo}ms</span>
                    </div>
                </div>
            `;
            
            if (produtos.length === 0) {
                html += '<div class="empty">Nenhum produto encontrado</div>';
            } else {
                html += '<div class="product-grid">';
                produtos.forEach(produto => {
                    html += `
                        <div class="product-card">
                            <div class="product-name">${produto.nome}</div>
                            <div class="product-price">R$ ${parseFloat(produto.preco).toFixed(2)}</div>
                            <div class="product-details">
                                <strong>Categoria:</strong> ${produto.categoria}<br>
                                <strong>Estoque:</strong> ${produto.estoque} unidades<br>
                                <strong>ID:</strong> ${produto.id}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            document.getElementById('results').innerHTML = html;
        }

        async function limparCache() {
            if (!confirm('Tem certeza que deseja limpar todo o cache?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/cache/limpar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                
                if (data.sucesso) {
                    alert('‚úÖ Cache limpo com sucesso!');
                }
            } catch (error) {
                alert('‚ùå Erro ao limpar cache: ' + error.message);
            }
        }

        async function mostrarEstatisticas() {
            mostrarLoading();
            try {
                const response = await fetch('/api/cache/stats');
                const data = await response.json();
                
                let html = '<h2 style="margin-bottom: 20px;">üìä Estat√≠sticas do Memcached</h2>';
                
                // data.stats agora √© um array ordenado
                data.stats.forEach(stat => {
                    const hitRate = parseInt(stat.get_hits) + parseInt(stat.get_misses) > 0
                        ? ((parseInt(stat.get_hits) / (parseInt(stat.get_hits) + parseInt(stat.get_misses))) * 100).toFixed(2)
                        : 0;
                    
                    html += `
                        <div class="stats">
                            <h3 style="margin-bottom: 15px; color: #667eea;">üñ•Ô∏è ${stat.server}</h3>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value">${stat.curr_items}</div>
                                    <div class="stat-label">Itens no Cache</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${stat.get_hits}</div>
                                    <div class="stat-label">Cache Hits</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${stat.get_misses}</div>
                                    <div class="stat-label">Cache Misses</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${hitRate}%</div>
                                    <div class="stat-label">Hit Rate</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${(parseInt(stat.bytes) / 1024).toFixed(2)} KB</div>
                                    <div class="stat-label">Mem√≥ria Usada</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${Math.floor(parseInt(stat.uptime) / 60)}</div>
                                    <div class="stat-label">Uptime (min)</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('results').innerHTML = html;
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        async function inspecionarCache() {
            mostrarLoading();
            try {
                const response = await fetch('/api/cache/dump');
                const data = await response.json();
                
                if (!data.sucesso) {
                    mostrarErro(data.erro);
                    return;
                }
                
                let html = '';
                let totalItens = 0;
                
                // data.dados agora √© um array
                const servidores = data.dados || [];
                for (const serverData of servidores) {
                    const servidor = serverData.servidor;
                    
                    if (serverData.erro) {
                        html += `
                            <div class="server-section">
                                <div class="server-title">
                                    <span>üñ•Ô∏è ${servidor}</span>
                                    <span class="item-count">Erro</span>
                                </div>
                                <div style="padding: 20px; background: #f8f9fa; border-radius: 0 0 10px 10px;">
                                    <p style="color: #f45c43;">‚ùå ${serverData.erro}</p>
                                </div>
                            </div>
                        `;
                        continue;
                    }
                    
                    const chaves = serverData.chaves || [];
                    totalItens += chaves.length;
                    
                    html += `
                        <div class="server-section">
                            <div class="server-title">
                                <span>üñ•Ô∏è ${servidor}</span>
                                <span class="item-count">${chaves.length} itens</span>
                            </div>
                    `;
                    
                    if (chaves.length === 0) {
                        html += `
                            <div style="padding: 20px; background: #f8f9fa; border-radius: 0 0 10px 10px;">
                                <p style="text-align: center; color: #999; font-style: italic;">Nenhum item no cache deste servidor</p>
                            </div>
                        `;
                    } else {
                        html += `
                            <table class="cache-keys-table">
                                <thead>
                                    <tr>
                                        <th style="width: 20%;">Chave</th>
                                        <th style="width: 40%;">Valor (Preview)</th>
                                        <th style="width: 10%;">Tamanho</th>
                                        <th style="width: 20%;">Expira</th>
                                        <th style="width: 10%;">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        chaves.forEach(item => {
                            const expiraEm = item.expiracao > 0 
                                ? new Date(item.expiracao * 1000).toLocaleString('pt-BR')
                                : 'Nunca';
                            
                            html += `
                                <tr>
                                    <td><span class="cache-key">${item.chave}</span></td>
                                    <td><span class="cache-value">${item.valor}</span></td>
                                    <td>${item.tamanho} bytes</td>
                                    <td style="font-size: 0.85em;">${expiraEm}</td>
                                    <td>
                                        <button class="btn-delete" onclick="deletarItemCache('${item.chave}')">
                                            üóëÔ∏è Deletar
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                </tbody>
                            </table>
                        `;
                    }
                    
                    html += '</div>';
                }
                
                if (totalItens === 0) {
                    html += '<div class="empty" style="margin-top: 20px;">Nenhum item encontrado no cache. Fa√ßa algumas buscas primeiro!</div>';
                } else {
                    html = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>üîç Inspe√ß√£o de Itens no Cache</h2>
                            <span class="badge time-badge">Total: ${totalItens} itens</span>
                        </div>
                    ` + html;
                }
                
                document.getElementById('results').innerHTML = html;
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        async function deletarItemCache(chave) {
            if (!confirm(`Tem certeza que deseja deletar "${chave}" do cache?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/cache/item/${encodeURIComponent(chave)}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.sucesso) {
                    alert(`‚úÖ ${data.mensagem}`);
                    // Recarregar a inspe√ß√£o de cache
                    await inspecionarCache();
                } else {
                    alert(`‚ùå Erro: ${data.erro}`);
                }
            } catch (error) {
                alert('‚ùå Erro ao deletar item: ' + error.message);
            }
        }

        async function buscarContador() {
            const nome = document.getElementById('contadorNome').value;
            if (!nome) {
                alert('Por favor, digite o nome do contador');
                return;
            }

            try {
                const response = await fetch(`/api/contador/${encodeURIComponent(nome)}`);
                const data = await response.json();
                
                if (data.sucesso) {
                    mostrarResultadoContador(data);
                } else {
                    mostrarErro(data.erro);
                }
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        async function incrementarContador() {
            await operacaoContador('incrementar', 1);
        }

        async function decrementarContador() {
            await operacaoContador('decrementar', 1);
        }

        async function incrementarContadorPor() {
            const quantidade = parseInt(document.getElementById('contadorQuantidade').value) || 1;
            await operacaoContador('incrementar', quantidade);
        }

        async function decrementarContadorPor() {
            const quantidade = parseInt(document.getElementById('contadorQuantidade').value) || 1;
            await operacaoContador('decrementar', quantidade);
        }

        async function resetarContador() {
            const nome = document.getElementById('contadorNome').value;
            if (!nome) {
                alert('Por favor, digite o nome do contador');
                return;
            }

            if (!confirm(`Tem certeza que deseja resetar o contador "${nome}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/contador/${encodeURIComponent(nome)}/resetar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.sucesso) {
                    mostrarResultadoContador(data);
                } else {
                    mostrarErro(data.erro);
                }
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        async function operacaoContador(operacao, quantidade) {
            const nome = document.getElementById('contadorNome').value;
            if (!nome) {
                alert('Por favor, digite o nome do contador');
                return;
            }

            try {
                const response = await fetch(`/api/contador/${encodeURIComponent(nome)}/${operacao}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantidade })
                });
                const data = await response.json();
                
                if (data.sucesso) {
                    mostrarResultadoContador(data);
                } else {
                    mostrarErro(data.erro);
                }
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        function mostrarResultadoContador(data) {
            const operacaoTexto = data.operacao ? ` (${data.operacao})` : '';
            const badgeTexto = data.fonte === 'DB' ? 'üíæ POSTGRESQL' : '‚ö° MEMCACHED';
            const badgeClass = data.fonte === 'DB' ? 'badge-db' : 'badge-cache';
            const corValor = data.fonte === 'DB' ? '#10b981' : '#667eea';
            const tempoTexto = data.tempo ? ` - ${data.tempo}ms` : '';
            
            const html = `
                <div class="result-header">
                    <h2>üî¢ Contador: ${data.contador}</h2>
                    <span class="badge ${badgeClass}">${badgeTexto}</span>
                </div>
                <div style="text-align: center; padding: 60px;">
                    <div style="font-size: 6em; font-weight: 700; color: ${corValor}; margin-bottom: 20px;">
                        ${data.valor}
                    </div>
                    <div style="font-size: 1.5em; color: #666;">
                        Valor atual${operacaoTexto}${tempoTexto}
                    </div>
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; font-size: 0.9em; color: #666;">
                        <strong>üí° Dica:</strong> Opera√ß√µes at√¥micas s√£o ${data.fonte === 'DB' ? 'seguras mas mais lentas no banco' : 'extremamente r√°pidas no Memcached'},
                        perfeitas para contadores, likes, views, etc.
                    </div>
                </div>
            `;
            document.getElementById('results').innerHTML = html;
        }

        // ============= FUN√á√ïES PARA BANCO DE DADOS =============

        async function buscarContadorDB() {
            const nome = document.getElementById('contadorNome').value;
            if (!nome) {
                alert('Por favor, digite o nome do contador');
                return;
            }

            try {
                const response = await fetch(`/api/contador-db/${encodeURIComponent(nome)}`);
                const data = await response.json();
                
                if (data.sucesso) {
                    data.fonte = 'DB';
                    mostrarResultadoContador(data);
                } else {
                    mostrarErro(data.erro);
                }
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        async function incrementarContadorDB() {
            await operacaoContadorDB('incrementar', 1);
        }

        async function decrementarContadorDB() {
            await operacaoContadorDB('decrementar', 1);
        }

        async function resetarContadorDB() {
            const nome = document.getElementById('contadorNome').value;
            if (!nome) {
                alert('Por favor, digite o nome do contador');
                return;
            }

            if (!confirm(`Tem certeza que deseja resetar o contador "${nome}" no banco?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/contador-db/${encodeURIComponent(nome)}/resetar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.sucesso) {
                    data.fonte = 'DB';
                    mostrarResultadoContador(data);
                } else {
                    mostrarErro(data.erro);
                }
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        async function operacaoContadorDB(operacao, quantidade) {
            const nome = document.getElementById('contadorNome').value;
            if (!nome) {
                alert('Por favor, digite o nome do contador');
                return;
            }

            try {
                const response = await fetch(`/api/contador-db/${encodeURIComponent(nome)}/${operacao}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantidade })
                });
                const data = await response.json();
                
                if (data.sucesso) {
                    data.fonte = 'DB';
                    mostrarResultadoContador(data);
                } else {
                    mostrarErro(data.erro);
                }
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        // ============= TESTES DE PERFORMANCE =============

        async function testePerformanceIncremento() {
            const nome = document.getElementById('contadorNome').value;
            const quantidade = parseInt(document.getElementById('contadorQuantidade').value) || 100;
            
            if (!nome) {
                alert('Por favor, digite o nome do contador');
                return;
            }

            mostrarLoading();

            try {
                // Teste Memcached
                const inicioCache = Date.now();
                for (let i = 0; i < quantidade; i++) {
                    await fetch(`/api/contador/${encodeURIComponent(nome)}/incrementar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantidade: 1 })
                    });
                }
                const tempoCache = Date.now() - inicioCache;

                // Teste PostgreSQL
                const inicioDB = Date.now();
                for (let i = 0; i < quantidade; i++) {
                    await fetch(`/api/contador-db/${encodeURIComponent(nome)}/incrementar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantidade: 1 })
                    });
                }
                const tempoDB = Date.now() - inicioDB;

                mostrarComparacao('Incremento', quantidade, tempoCache, tempoDB);
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        async function testePerformanceDecremento() {
            const nome = document.getElementById('contadorNome').value;
            const quantidade = parseInt(document.getElementById('contadorQuantidade').value) || 100;
            
            if (!nome) {
                alert('Por favor, digite o nome do contador');
                return;
            }

            mostrarLoading();

            try {
                // Teste Memcached
                const inicioCache = Date.now();
                for (let i = 0; i < quantidade; i++) {
                    await fetch(`/api/contador/${encodeURIComponent(nome)}/decrementar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantidade: 1 })
                    });
                }
                const tempoCache = Date.now() - inicioCache;

                // Teste PostgreSQL
                const inicioDB = Date.now();
                for (let i = 0; i < quantidade; i++) {
                    await fetch(`/api/contador-db/${encodeURIComponent(nome)}/decrementar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantidade: 1 })
                    });
                }
                const tempoDB = Date.now() - inicioDB;

                mostrarComparacao('Decremento', quantidade, tempoCache, tempoDB);
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        async function compararAmbos() {
            const nome = document.getElementById('contadorNome').value;
            const quantidade = parseInt(document.getElementById('contadorQuantidade').value) || 100;
            
            if (!nome) {
                alert('Por favor, digite o nome do contador');
                return;
            }

            mostrarLoading();

            try {
                // Resetar ambos
                await fetch(`/api/contador/${encodeURIComponent(nome)}/resetar`, { method: 'POST' });
                await fetch(`/api/contador-db/${encodeURIComponent(nome)}/resetar`, { method: 'POST' });

                // Teste Incremento Cache
                const inicioIncCache = Date.now();
                for (let i = 0; i < quantidade; i++) {
                    await fetch(`/api/contador/${encodeURIComponent(nome)}/incrementar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantidade: 1 })
                    });
                }
                const tempoIncCache = Date.now() - inicioIncCache;

                // Teste Incremento DB
                const inicioIncDB = Date.now();
                for (let i = 0; i < quantidade; i++) {
                    await fetch(`/api/contador-db/${encodeURIComponent(nome)}/incrementar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantidade: 1 })
                    });
                }
                const tempoIncDB = Date.now() - inicioIncDB;

                // Teste Decremento Cache
                const inicioDecCache = Date.now();
                for (let i = 0; i < quantidade; i++) {
                    await fetch(`/api/contador/${encodeURIComponent(nome)}/decrementar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantidade: 1 })
                    });
                }
                const tempoDecCache = Date.now() - inicioDecCache;

                // Teste Decremento DB
                const inicioDecDB = Date.now();
                for (let i = 0; i < quantidade; i++) {
                    await fetch(`/api/contador-db/${encodeURIComponent(nome)}/decrementar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantidade: 1 })
                    });
                }
                const tempoDecDB = Date.now() - inicioDecDB;

                mostrarComparacaoCompleta(quantidade, {
                    incCache: tempoIncCache,
                    incDB: tempoIncDB,
                    decCache: tempoDecCache,
                    decDB: tempoDecDB
                });
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        function mostrarComparacao(operacao, quantidade, tempoCache, tempoDB) {
            const velocidade = (tempoDB / tempoCache).toFixed(2);
            const diferenca = tempoDB - tempoCache;
            
            const html = `
                <div class="result-header">
                    <h2>üìä Compara√ß√£o de Performance - ${operacao}</h2>
                    <span class="badge time-badge">${quantidade} opera√ß√µes</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; padding: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 15px; color: white; text-align: center;">
                        <div style="font-size: 1.2em; margin-bottom: 20px;">‚ö° Memcached</div>
                        <div style="font-size: 4em; font-weight: 700; margin-bottom: 10px;">${tempoCache}ms</div>
                        <div style="font-size: 1.1em; opacity: 0.9;">${(tempoCache / quantidade).toFixed(2)}ms por opera√ß√£o</div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 40px; border-radius: 15px; color: white; text-align: center;">
                        <div style="font-size: 1.2em; margin-bottom: 20px;">üíæ PostgreSQL</div>
                        <div style="font-size: 4em; font-weight: 700; margin-bottom: 10px;">${tempoDB}ms</div>
                        <div style="font-size: 1.1em; opacity: 0.9;">${(tempoDB / quantidade).toFixed(2)}ms por opera√ß√£o</div>
                    </div>
                </div>
                
                <div style="text-align: center; padding: 30px; background: #f8f9fa; border-radius: 10px; margin: 20px;">
                    <div style="font-size: 2.5em; font-weight: 700; color: #667eea; margin-bottom: 15px;">
                        ${velocidade}x mais r√°pido
                    </div>
                    <div style="font-size: 1.2em; color: #666;">
                        Memcached foi ${diferenca}ms mais r√°pido que PostgreSQL
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; font-size: 0.9em; color: #666;">
                        üí° O Memcached usa opera√ß√µes at√¥micas em mem√≥ria, enquanto o PostgreSQL precisa fazer lock de linhas, 
                        gravar em disco e manter transa√ß√µes ACID.
                    </div>
                </div>
            `;
            document.getElementById('results').innerHTML = html;
        }

        function mostrarComparacaoCompleta(quantidade, tempos) {
            const velocidadeInc = (tempos.incDB / tempos.incCache).toFixed(2);
            const velocidadeDec = (tempos.decDB / tempos.decCache).toFixed(2);
            const totalCache = tempos.incCache + tempos.decCache;
            const totalDB = tempos.incDB + tempos.decDB;
            const velocidadeTotal = (totalDB / totalCache).toFixed(2);
            
            const html = `
                <div class="result-header">
                    <h2>üìä Compara√ß√£o Completa de Performance</h2>
                    <span class="badge time-badge">${quantidade * 2} opera√ß√µes totais</span>
                </div>
                
                <div style="padding: 30px;">
                    <h3 style="text-align: center; margin-bottom: 30px; color: #333;">‚ûï Incrementos</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; color: white; text-align: center;">
                            <div style="font-size: 1em; margin-bottom: 15px;">‚ö° Memcached</div>
                            <div style="font-size: 3em; font-weight: 700;">${tempos.incCache}ms</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 12px; color: white; text-align: center;">
                            <div style="font-size: 1em; margin-bottom: 15px;">üíæ PostgreSQL</div>
                            <div style="font-size: 3em; font-weight: 700;">${tempos.incDB}ms</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-bottom: 40px; font-size: 1.3em; color: #667eea; font-weight: 600;">
                        ${velocidadeInc}x mais r√°pido com Memcached
                    </div>
                    
                    <h3 style="text-align: center; margin-bottom: 30px; color: #333;">‚ûñ Decrementos</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; color: white; text-align: center;">
                            <div style="font-size: 1em; margin-bottom: 15px;">‚ö° Memcached</div>
                            <div style="font-size: 3em; font-weight: 700;">${tempos.decCache}ms</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 12px; color: white; text-align: center;">
                            <div style="font-size: 1em; margin-bottom: 15px;">üíæ PostgreSQL</div>
                            <div style="font-size: 3em; font-weight: 700;">${tempos.decDB}ms</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-bottom: 40px; font-size: 1.3em; color: #667eea; font-weight: 600;">
                        ${velocidadeDec}x mais r√°pido com Memcached
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 40px; border-radius: 15px; color: white; text-align: center;">
                        <div style="font-size: 1.5em; margin-bottom: 20px;">üèÜ Resultado Final</div>
                        <div style="font-size: 4em; font-weight: 700; margin-bottom: 15px;">${velocidadeTotal}x</div>
                        <div style="font-size: 1.2em; opacity: 0.95;">
                            Memcached: ${totalCache}ms | PostgreSQL: ${totalDB}ms
                        </div>
                        <div style="margin-top: 25px; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 10px; font-size: 0.95em;">
                            üí° Diferen√ßa de ${totalDB - totalCache}ms para ${quantidade * 2} opera√ß√µes at√¥micas
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('results').innerHTML = html;
        }
    </script>
</body>
</html>
